# Slug Generation - How It Works

## Current Status

The `generate_slug` function exists in the database but is **NOT automatically triggered** yet. You need to set up a database trigger to make it work automatically.

## When Slugs Should Be Generated

Slugs should be automatically generated when:
1. **New brand is created** (INSERT)
2. **Brand name is updated** (UPDATE)
3. **Brand exists without a slug** (backfill existing brands)

## Solution: Database Trigger

I've created a SQL migration file `add_brand_slug_trigger.sql` that will:

1. **Create a trigger function** that:
   - Automatically generates slug from brand name when brand is inserted/updated
   - Only generates if slug is NULL or empty (allows manual override)
   - Ensures uniqueness by appending numbers if duplicate slugs exist

2. **Create a trigger** that fires BEFORE INSERT or UPDATE on brands table

## How to Enable Automatic Slug Generation

### Step 1: Run the Trigger Migration

1. Go to your Supabase Dashboard → SQL Editor
2. Run `add_brand_slug_trigger.sql`
3. This will create the trigger that auto-generates slugs

### Step 2: Backfill Existing Brands (Optional)

If you have existing brands without slugs, you can:

**Option A: Use SQL (in Supabase SQL Editor)**
```sql
-- Generate slugs for all brands that don't have one
UPDATE brands
SET slug = generate_slug(COALESCE(name, 'brand-' || id::TEXT))
WHERE slug IS NULL OR slug = '';
```

**Option B: Use Python Script**
```python
from app.services.supabase_service import SupabaseService

supabase = SupabaseService()
brands = supabase.client.table("brands").select("*").execute().data

for brand in brands:
    if not brand.get('slug'):
        # Trigger update which will auto-generate slug via trigger
        supabase.client.table("brands").update({
            "name": brand["name"]  # Just update name to trigger slug generation
        }).eq("id", brand["id"]).execute()
```

## How It Works After Setup

### Automatic Behavior:
- ✅ **New brand created** → Slug auto-generated from name
- ✅ **Brand name updated** → Slug auto-regenerated (if slug was empty)
- ✅ **Manual slug set** → Trigger respects manual slugs (won't overwrite)

### Example:
```sql
-- Insert new brand
INSERT INTO brands (id, name) VALUES (9999, 'McRAE Analytics');

-- Result: slug automatically set to 'mcrae-analytics'
-- If 'mcrae-analytics' exists, it becomes 'mcrae-analytics-1', etc.
```

## Current Code Behavior

Currently, the `upsert_brands` function in `app/services/supabase_service.py` does NOT generate slugs. After running the trigger migration, slugs will be automatically generated by the database trigger.

## Testing

After setting up the trigger:

1. **Test new brand**:
   ```python
   supabase.client.table("brands").insert({
       "id": 9999,
       "name": "Test Brand Name"
   }).execute()
   # Check: slug should be "test-brand-name"
   ```

2. **Test update**:
   ```python
   supabase.client.table("brands").update({
       "name": "New Brand Name"
   }).eq("id", 9999).execute()
   # Check: slug should update to "new-brand-name" (if slug was empty)
   ```

3. **Test manual override**:
   ```python
   supabase.client.table("brands").update({
       "slug": "custom-slug"
   }).eq("id", 9999).execute()
   # Check: slug remains "custom-slug" (not overwritten)
   ```

## Summary

- **Before**: `generate_slug` function exists but never called
- **After running trigger**: Slugs auto-generated on INSERT/UPDATE
- **Manual override**: Still possible by explicitly setting slug
- **Uniqueness**: Automatically handled by trigger

